<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>

    <title>De-stress Lab: For a Ruff Day</title>

    <!-- jQuery library -->
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <!-- Bootstrap -->
    <!-- Latest compiled and minified CSS -->
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
    <!-- Latest compiled JavaScript -->
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
  </head>

  <body>
    <noscript>
      You need to enable JavaScript to run this app.
    </noscript>

    <!-- Navigation bar -->
    <nav class='navbar navbar-light bg-light'>
      <div class='nav navbar-nav navbar-right'>
        <ul id='navbar-contents' class='nav navbar-nav'>
        </ul>
      </div>
    </nav>

    <!-- Styling -->
    <style>
      .navbar {
        margin: 0px 20px;
      }

      h1 {
        text-align: center;
        font: italic 30px arial, sans-serif;
        color: purple;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      .container {
        display: flex;
        justify-content: center;
      }

      #game-panel-container {
        overflow: visible;
        display: flex;
      }

      #main-screen {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: auto;
      }

      #game-view {
        position: absolute;
        width: 100%;
        height: 100%;
        padding: 0;
      }

      .modal {
        position: absolute;
        top: 20%;
        left: 10%;
        width: 80%;
        height: 90%;
      }

      .select-panel:hover {
        transition: 0.3s;
        box-shadow: 0 10px 10px 10px #6b217a8a;
      }

      .col-centered {
        float: none;
        margin: auto;
        margin-right: 22.5%;
      }

      #instructions {
        position: absolute;
        color: white;
        bottom: 8em;
        left: 15em;
      }

      #music-cred {
        font-weight: 700;
        position: absolute;
        bottom: 2em;
        left: 1em;
      }

      #new-breed {
        width: 50%;
        height: 35px;
        position: absolute;
        right: 1em;
        bottom: 0em;
        text-align: center;
      }

      .shooter {
          text-align: justify;
          justify-content: center;
      }
      .pop {
          /* text-align: justify; */
          /* justify-content: center; */
      }

      .scrollable {
        max-height: 200px;
        overflow-y: auto;
      }

      .modal-body scrollable {
        max-height: 50%;
        overflow-y: auto;
      }

    </style>

    <!-- Login and Signup -->
    <script type='text/javascript'>
      $(document).ready(function () {
        var auth = false;
        var navbarContents = $('#navbar-contents');
        var signout = "<li id='signout'><a href='#' data-toggle='modal' data-target='#signout-modal'>Sign Out</a></li>";
        var accSettings = "<li id='accsettings'><a href='#' data-toggle='modal' data-target='#settings-modal'>Account Settings</a></li>";
        var backButton = "<li id='back'><a href='#'>Back</a></li>";
        var login = "<li id='login'><a href='#' data-toggle='modal' data-target='#login-modal'>Log In</a></li>";
        var signup = "<li id='signup'><a href='#' data-toggle='modal' data-target='#signup-modal'>Sign Up</a></li>";
        var currentBreeds = [];
        var currentStressors = [];

        /**
         * Create the element representing that breed, add the remove button to it
         */
        function addBreed(newBreed) {
          var item = document.createElement('div');
          item.id = newBreed + '-wrapper';
          item.classList = ['list-group-item'];
          item.innerHTML = newBreed;
          var icon1 = document.createElement('span');
          icon1.id = newBreed.toLowerCase() + '-wrapper';
          icon1.classList = ['pull-right'];
          var icon2 = document.createElement('span');
          icon2.id = 'remove-' + item.id;
          icon2.classList = ['glyphicon  glyphicon-trash'];
          icon1.append(icon2);
          item.append(icon1);
          $('#breed-pref').append(item);
          $('#' + icon2.id).on('click',
          function () {
            $('#' + item.id).remove();
            currentBreeds.splice(currentBreeds.indexOf(newBreed), 1);
            $.post("/user/removeBreed", {toRemove: item.innerHTML}, (data, status) => {
                console.log(data);
            });
          });
        }

        /**
         * Create the element representing that stress, add the remove button to it
         */
        function addStress(newStressor) {
          var item = document.createElement('div');
          /*
          The string functions applied below here are just in case the API changes
          and allows for spacing in their names.
          */
          item.id = newStressor.toLowerCase().split(' ').join('-') + '-wrapper';
          item.classList = ['list-group-item'];
          item.innerHTML = newStressor;
          var icon1 = document.createElement('span');
          icon1.id = newStressor.toLowerCase() + '-wrapper';
          icon1.classList = ['pull-right'];
          var icon2 = document.createElement('span');
          icon2.id = 'remove-' + item.id;
          icon2.classList = ['glyphicon  glyphicon-trash'];
          icon1.append(icon2);
          item.append(icon1);
          $('#stress-list').append(item);
          $('#' + icon2.id).on('click',
          function () {
            $('#' + item.id).remove();
            currentStressors.splice(currentStressors.indexOf(newStressor), 1);
            $.post("/user/removeStressor", {toRemove: item.innerHTML}, (data, status) => {
                console.log(data);
            });
          });
        }

        /**
         * Setup the buttons and breed/stressors for logged in user
         */
        function loginSetup(username, userData) {
          $('#login').remove();
          $('#signup').remove();
          $('#navbar-contents').append(accSettings);
          $('#navbar-contents').append(signout);

          // This will be a fetch to backend user data in Assignment 3
          currentBreeds = userData.breeds;
          currentStressors = userData.stressors;

          for(var i = 0; i < currentBreeds.length; i++) {
              addBreed(currentBreeds[i]);
          }
          for(var i = 0; i < currentStressors.length; i++) {
              addStress(currentStressors[i]);
          }

          auth = true;
        }

        function logoutSetup() {
          $('#signout').remove();
          $('#accsettings').remove();

          // remove from account settings modal
          var nodes = document.getElementById('breed-pref').childNodes;
          var len = nodes.length;
          for(var i = len - 1; i >= 0; i--) {
            nodes[i].remove();
          }
          nodes = document.getElementById('stress-list').childNodes;
          len = nodes.length;
          for(var i = len - 1; i >= 0; i--) {
            nodes[i].remove();
          }

          navbarContents.append(login);
          navbarContents.append(signup);

          currentBreeds = null;
          currentStressors = null;
        }

        /**
         * This will handle login during assignment 3 but for now it will
         * print the username and password to console and allow a user
         * to log in, regardless of correct credentials.
         */
        $('#login-modal #login-button').on('click', function () {
          var username = $('#login-modal #username').val();
          var password = $('#login-modal #login-pwd').val();

          // Log it, in Assignment 3, we will send it to the server instead
          console.log('username: ' + username);
          console.log('password: ' + password);

          $.post("/user/login", {username: username, password: password}, (data, status) => {
            console.log(data)
            loginSetup(username, JSON.parse(data));
          });
        });

        /**
         * Similar to login, a user can sign up without proper credentials,
         * as long as the two passwords match.
         */
        $('#signup-modal #signup-button').on('click', function () {
          var username = $('#signup-modal #signup-username').val();
          var pwd1 = $('#signup-modal #pwd').val();
          var pwd2 = $('#signup-modal #re-enter').val();

          // Log it, in Assignment 3, we will send it to the server instead
          console.log('username: ' + username);
          console.log('password: ' + pwd1);
          console.log('password: ' + pwd2);

          if (pwd1 === pwd2) {
            $.post("/user", {username: username, password: pwd1}, (data, status) => {
              console.log(data)
              loginSetup(username, JSON.parse(data));
            });
          } else {
              alert('Sign up unsuccessful.');
          }
        });

        /**
         * Returns login and signup buttons to where they were and removes
         * the sign out button.
         */
        $('#signout-modal #signout-button').on('click', function () {
          var navbarContents = $('#navbar-contents');
          $.get('/user/logout', (data, status) => {
            console.log(data);
          });
          logoutSetup();
          auth = false;
        });

        var availableBreeds = [];
        $.ajax({
            url: "https://dog.ceo/api/breeds/list/all",
            json: true,
            success: function(response) {
                availableBreeds = Object.keys(response.message);
                var list = document.getElementById('dropdown-menu');
                for(var i = 0; i < availableBreeds.length; i++) {
                    var entry = document.createElement('li');
                    entry.id = availableBreeds[i] + '-dropdown-box';
                    entry.className = 'dropdown-element'
                    entry.innerHTML = availableBreeds[i];
                    list.append(entry);
                }
                // Change the input field to whatever is selected in dropdown
                $('#dropdown-menu li').on('click', function () {
                    document.getElementById('new-breed').value = $(this).text();
                })
            }
        });

        $('#addbreed-modal #save-breed').on('click', function () {
          var breed = $('#addbreed-modal #new-breed').val();

          if(currentBreeds.includes(breed)) {
              alert("Breed already exists in your saved breeds");
          } else {
              addBreed(breed);
              currentBreeds.push(breed);
              $.post("/user/addBreed", {newBreed: breed}, (data, status) => {
                  console.log(data);
              });
          }
        });

        //when a stressor is added attach a listener to the remove icon too
        $('#addstress-modal #save-stressor').on('click', function(){
          var stress = $('#addstress-modal #new-stressor').val();
          if(currentStressors.includes(stress)) {
              alert("Stressor already exists in your saved stressors");
          } else {
              addStress(stress);
              currentStressors.push(stress);
              $.post("/user/addStressor", {newStressor: stress}, (data, status) => {
                  console.log(data);
              });
          }
        });

        $('#confirm-modal #c-delete-acc').on('click', function () {
          console.log('delete')
          $.ajax({
            url: '/user',
            type: 'DELETE',
            success: (data, status) => {
              console.log(data);
            }
          });
          logoutSetup();
          auth = false;
        });

        $('[data-toggle="popover"]').popover();

        if(auth) {
          navbarContents.append(accSettings);
          navbarContents.append(signout);
        } else {
          navbarContents.append(login);
          navbarContents.append(signup);
        }
      });
    </script>

    <h1> Welcome to the De-Stress Lab!</h1>

    <div id='main-screen'>
      <div id='game-panel-container' class='container'>
        <div id="shooter" class="row">
          <div class="col-sm-5 col-lg-offset-1">
            <img id='shooter-game' class='img-rounded select-panel'
              src='images/grape.png' alt='Grape' height='50%' width='80%'>
              <p style= "max-width: 320px; text-align: center;">
                Use arrow keys to move and space to shoot.
                If you don't want to use the bullets,
                you can simply attack the stresses with the character.
              </p>
          </div>
          <div class="col-sm-5">
            <img id='pop-game' class='img-rounded select-panel'
              src='images/pop.png' alt='Pop' height='50%' width='70%'>
            <p style= "max-width: 300px; text-align: center;">
              Use your mouse or tap your screen to pop the bouncing dog bubbles.
            </p>
          </div>
        </div>
        </div>
      </div>
    </div>

    <script type='text/javascript'>
      $('#pop-game').on('click', function () {
          location.href = "/game/pop";
      });
      $('#shooter-game').on('click', function () {
          location.href = "/game/shooter";
      });
    </script>

    <!--
      Modals, following Bootstrap modal format.
    -->
    <div id='login-modal'class='modal fade'>
      <div class='modal-content'>
          <div class='modal-header'>
            <h2>Log In</h2>
          </div>
          <div class='modal-body'>
              <div class='form-group'>
                <label for='username'>Username</label>
                <input type='username' class='form-control' id='username'>
              </div>
              <div class='form-group'>
                <label for='login-pwd'>Password</label>
                <input type='password' class='form-control' id='login-pwd'>
              </div>
          </div>
          <div class='modal-footer'>
            <button id='login-button' type='button' class='btn btn-default' data-dismiss='modal'>Log In</button>
            <button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>
          </div>
      </div>
    </div>

    <div id='signup-modal'class='modal fade'>
      <div class='modal-content'>
          <div class='modal-header'>
            <h2>Sign Up</h2>
          </div>
          <div class='modal-body'>
              <div class='form-group'>
                <label for='signup-username'>Username</label>
                <input type='username' class='form-control' id='signup-username'>
              </div>
              <div class='form-group'>
                <label for='pwd'>Password</label>
                <input type='password' class='form-control' id='pwd'>
              </div>
              <div class='form-group'>
                <label for='re-enter'>Re-enter Password</label>
                <input type='password' class='form-control' id='re-enter'>
              </div>
          </div>
          <div class='modal-footer'>
            <button id='signup-button' type='button' class='btn btn-default' data-dismiss='modal'>Sign Up</button>
            <button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>
          </div>
      </div>
    </div>

    <div id='signout-modal'class='modal fade'>
      <div class='modal-content'>
          <div class='modal-header'>
            <h2>Sign Out</h2>
          </div>
          <div class='modal-body'>
              <div class='form-group'>
                <p>Would you like to sign out of your account?</p>
              </div>
          </div>
          <div class='modal-footer'>
            <button id='signout-button' type='button' class='btn btn-default' data-dismiss='modal'>Yes</button>
            <button type='button' class='btn btn-default' data-dismiss='modal'>No</button>
          </div>
      </div>
    </div>
  </body>

  <div id='settings-modal'class='modal fade'>
    <div class='modal-content'>
        <div class='modal-header'>
          <button type='button' class='close' data-dismiss='modal'>&times;</button>
          <ul class='nav nav-tabs'>
            <li class='active'><a data-toggle='tab' href='#breed-tab'>Breed Preference</a></li>
            <li><a data-toggle='tab' href='#stress-tab'>Stress List</a></li>
            <li><a data-toggle='tab' href='#delete-tab'>Delete</a></li>
          </ul>
        </div>
        <div class='modal-body'>
          <div class='tab-content'>
            <div id='breed-tab' class='tab-pane fade in active'>
              <h3>My Breeds</h3>
              <div class='list-group scrollable' id='breed-pref'></div>
              <button id='add-stress' type='button' class='btn btn-default' data-toggle='modal' data-target='#addbreed-modal'>Add</button>
            </div>
            <div id='stress-tab' class='tab-pane fade'>
              <h3>My Stressors</h3>
              <div class='list-group scrollable' id='stress-list'></div>
              <button id='add-stress' type='button' class='btn btn-default' data-toggle='modal' data-target='#addstress-modal'>Add</button>
            </div>
            <div id='delete-tab' class='tab-pane fade'>
              <h3>Delete Account</h3>
              <button id='delete-acc' type='button' class='btn btn-default' data-toggle='modal' data-target='#confirm-modal'>Delete Account</button>
            </div>
          </div>
        </div>
    </div>
  </div>

  <div id='confirm-modal'class='modal fade'>
    <div class='modal-content'>
      <div class='modal-header'>
        <h2>Are you sure you would like to delete your account?</h2>
      </div>
      <div class='modal-footer'>
        <button id='c-delete-acc' type='button' class='btn btn-default' data-dismiss='modal'>Yes</button>
        <button type='button' class='btn btn-default' data-dismiss='modal'>No</button>
      </div>
    </div>
  </div>

  <div id='addbreed-modal'class='modal fade'>
    <div class='modal-content'>
        <div class='modal-header'>
          <button type='button' class='close' data-dismiss='modal'>&times;</button>
          <h2>New Breed</h2>
        </div>
        <div class='modal-body'>
          <div class='input-group'>
            <div class='dropdown'>
              <button class='btn btn-primary dropdown-toggle' type='button' data-toggle='dropdown'>Breeds
              <span class='caret'></span></button>
              <ul class='dropdown-menu scrollable' id='dropdown-menu'></ul>
            </div>
            <input type='text' class='form-control' id='new-breed' disabled='disabled'></input>
            <div class='input-group-btn'>
              <button class='btn btn-default' type='submit' id='save-breed'><i class='glyphicon glyphicon-plus-sign'></i></button>
            </div>
          </div>
        </div>
    </div>
  </div>

  <div id='addstress-modal'class='modal fade'>
    <div class='modal-content'>
        <div class='modal-header'>
          <button type='button' class='close' data-dismiss='modal'>&times;</button>
          <h2>New Stressor</h2>
        </div>
        <div class='modal-body'>
          <div class='input-group'>
            <input type='text' class='form-control' id='new-stressor'>
            <div class='input-group-btn'>
              <button class='btn btn-default' type='submit' id='save-stressor'><i class='glyphicon glyphicon-plus-sign'></i></button>
            </div>
          </div>
        </div>
    </div>
  </div>

  </body>
</html>
